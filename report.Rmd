---
title: "Birth Country Imputation"
subtitle: "Advanced R for Econometricians"
type: "Term Project"
author: "Jamie Christy (256535) & Danaia Burtseva (237132)"
discipline: "MSc. Econometrics"
date: "`r Sys.Date()`"
studid: "256535 & 237132"
supervisor: "Prof. Dr. Martin Christopher Arnold"
secondsupervisor: "M.Sc. Martin Schmelzer"
# ssemester: 1
semester: "Summer Term 2025"
deadline: "September 8, 2025"
output:
  pdf_document:
    keep_tex: yes
    template: template.tex
    fig_caption: yes
    citation_package: biblatex
    number_sections: true
toc: true
lot: true
lof: true
graphics: true
tables: true
biblio-title: References
fontsize: 11pt
geometry: lmargin=4cm,rmargin=3.5cm,tmargin=2.5cm,bmargin=2.5cm
biblio-files: references.bib
classoption: a4paper
language: english
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(gt)
library(dplyr)
library(broom)
```

# Introduction

Missing or non-standard data poses a persistent challenge in empirical research, but can sometimes be ameliorated. This paper demonstrates a practical implementation of imputing missing demographic information using auxiliary features and external reference datasets. 

We consider a set of mock administrative data in which 40% of records are missing country of birth, and implement a procedure to assign each of these a 'best guess' country. The challenges are broadly twofold: we must handle inconsistent formatting in birth city names, and we must match birth cities or citizenships to countries.

Our approach combines multiple imputation strategies in a hierarchical framework, beginning with the most reliable sources (exact city matches in official databases) and progressively incorporating less certain approaches (citizenship-based imputation) for remaining missing values. We use direct indications of country in birth city names, matches to German or international reference datasets, cities with some non-missing values, typical citizenships associated with cities, and a few manual mappings to assign cities to countries. When direct city matching fails, we fall back to record-level indication of citizenship, which generally but not always leads to identification of 'Germany.'

The majority of incomplete records are matched to a German city by direct reference, and many are matched using appearances of their birth city in the complete records, then we usually fall back to citizenship. Post-imputation, we see a population born 29% in Germany, 9% in Poland, 8% in Syria, and a long tail of other countries.

The remainder of this paper is structured as follows. Section \ref{sec:data} describes the data sources and the preprocessing to relate them to each other. Section \ref{sec:imputation} details our imputation methodology, including the hierarchical matching process and the stepwise impacts on the incomplete records. Section \ref{sec:results} presents the results, including final success rates and a visualization of the geographic distribution of imputed birth countries. Section \ref{sec:conclusion} discusses the limitations of our approach, potential extensions, and general takweaways for similar data imputation challenges.

# Data {#sec:data}

```{r data, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load and prepare summary statistics
raw_df <- read.csv("data/birthdata.csv", sep=";")
raw_ct <- nrow(raw_df)
mi_ct <- sum(is.na(raw_df$birth_country))
mi_pct <- round(mi_ct/raw_ct * 100, 1)
deu_ct <- sum(raw_df$citizenship_1 == "0" | raw_df$citizenship_2 == "0", na.rm = TRUE)
deu_pct <- round(deu_ct/raw_ct * 100, 1)

NNN<-0
```

Our work combines a given incomplete 'birth data' dataset with several external reference sources to enable systematic imputation of missing birth country information:

* country codes from Statistisches Bundesamt (DESTATIS)
* modern municipal directory from Die Statistischen Ämter des Bundes und der Länder
* historical eastern territories of Germany from NNNTODO
* major modern international cities from the World Cities Database

## Primary dataset

Our dataset contains `r format(raw_ct, big.mark = ",")` observations of individuals with citizenship and birth location information, of which approximately `r format(mi_ct, big.mark = ",")` records (`r mi_pct`%) are missing birth country data. At a glance, the records show a strong German orientation, with `r deu_pct`% of all records marking a German citizenship and many incomplete records indicating German birth cities. In fact, there are no complete records with a German (000) birth country marked, suggesting a systematic null for German country of birth.

```{r raw_summary}
# raw_df %>% 
#   summarise(
#     `Total Records` = n(),
#     `Missing Birth Country` = sum(is.na(birth_country)),
#     `Missing Birth City` = sum(is.na(birth_city)),
#     `German Citizenship` = sum(citizenship_1 == "0" | citizenship_2 == "0", na.rm = TRUE)
#   ) %>%
#   knitr::kable(caption = "Dataset Overview")
```

Given the expectation of substantial German origin for the incomplete records, we focus on understanding and identifying German (or formerly German) cities, and prioritize European cities in cases of ambiguity, while maintaining global coverage for edge cases.

## External Reference Sources

We integrate four primary external datasets to enable comprehensive geographic matching:

### Destatis

The German Federal Statistical Office (*Statistisches Bundesamt*) provides standardized country and nationality codes through their "Staatsangehörigkeitsgebietsschlüssel" [@destatis2024]. This table (hereafter "DESTATIS codes") maps three-digit country codes to modern country names, nationalities, and ISO codes. We use this primarily to translate numeric country codes in our data to readable country names and to ensure consistent country assignments that align with German administrative standards.

### German Municipal Listing

The Statistical Offices of the Federation and States (*Die Statistischen Ämter des Bundes und der Länder*) publish an annual directory of municipal and city administrations [@statsaemter2023]. This "Municipal Directory" contains comprehensive listings of German cities and municipalities as of January 2023. We extract city names from both the official seat locations and administrative designations, providing a list of approximately `r NNN` potential names for German localities, including variations. This serves as our primary reference for identifying German birth cities, with both exact matching and simplified matching (removing common prefixes and administrative suffixes).

### Ostgebeite

For historical German territories now part of other countries, we manually compile a reference list of major cities in former German regions including East Prussia, Silesia, and Pomerania. This "Ostgebiete reference" handles cities like Königsberg (now Kaliningrad) or Breslau (now Wrocław) that may appear in historical records but no longer exist under German administration.

### International

We incorporate the World Cities Database from SimpleMaps [@simplemaps2024], which provides comprehensive global city coverage with population weights and country assignments. This "World Cities DB" contains over 40,000 cities worldwide and serves as our fallback reference for non-German locations. While the primary impact is modest (clarifying `r NNN` of our otherwise unmatched cases), it provides important validation that remaining unmatched records do not correspond to major international cities, supporting our assumption that most represent German locations with non-standard spellings.

```{r data-overview, results='asis'}
# Summary table of data sources and their contributions
overview_table <- data.frame(
  Metric = c("Total Records", "Missing Birth Country", "German Citizenship"),
  Count = c(
    format(raw_ct, big.mark = ","),
    format(mi_ct, big.mark = ","),
    format(deu_ct, big.mark = ",")
  ),
  Percentage = c(
    "100%",
    paste0(mi_pct, "%"),
    paste0(deu_pct, "%")
  )
)

# knitr::kable(overview_table, caption = "Dataset Overview")
```

The combination of these sources clarifies and prioritizes the expected German-heavy geographic distribution of our records, while also covering basic international and historical considerations.

# Imputation

There are a number of factors we can leverage to impute missing information:
* many records are complete, and can be used to identify cities or patterns.
* many incomplete records are likely to be German, and to follow naming patterns used in German administration.
* some records directly indicate a country or a well-known modern city.

Generally, we try to identify the birth country based on birth city. This is complicated by several factors that make birth city names non-trivial to attach to a country.
* birth city names often have non-standardized formats, inconsistent transliterations, or misspellings.
* many birth city names include a slash ("/") which *often but not always* indicates a sub/super unit of geography (typically City/District).
* birth cities may indicate a historical name or a region rather than a city.

The imputation process follows a hierarchical progression, beginning with the most reliable sources and progressively incorporating less certain approaches for remaining missing values. We impute missing birth countries based on the following ordered approach:

1. **Direct country indications**: Parenthetical country names in birth city entries
2. **German city matching**: Exact and simplified matches to official German municipal directories  
3. **Empirical city-country patterns**: Dominant country assignments from complete records
4. **International city matching**: Matches to major world cities database
5. **Citizenship-based inference**: Primary and secondary citizenship information
6. **Default citizenship assignment**: Final fallback to primary citizenship

Each record progresses through this hierarchy until a country assignment is made. The detailed implementation of each step is described below.

## Data Standardization

Before attempting any geographic matching, we standardize birth city names to improve matching accuracy. This preprocessing involves several steps:

- **Character standardization**: Remove inconsistent punctuation, convert to uppercase, and strip accents using ASCII transliteration
- **Slash-based splitting**: Split entries containing "/" into separate city components, as these will not natively match to the municipal names we rely on. Given that the split often indicates city/district or city/region relationships, some information is lost, but a match for a city *or* a region is often sufficient to identify a country of birth.
<!-- - **Fuzzy matching standardization**: Apply edit-distance matching to correct common spelling variations for frequently appearing city names -->
- **Parenthetical extraction**: Identify and extract country names appearing in parentheses (e.g., "BUDAPEST (HUNGARY)")

After standardization, records are processed at the city-component level, then reaggregated to the individual level using a smart collapse function that keeps all potential matches. Relatively few (`r NNN``) records are multi-matched, and the 'better' match is selected by using the same overall hierarchy of match reliability.

## Direct Country Indications

The simplest cases involve birth city entries that explicitly name a country in parentheses. We extract these parenthetical country names and check them against our DESTATIS country reference to assign the appropriate country code. For example, "PARIS (FRANCE)" or "MOSKAU (RUSSLAND)" receive immediate country assignments. Similarly, 'city' names that wholly match a country named in DESTATIS, eg "JORDAN" are assigned to that country.

## German City Identification

Given the strong German orientation of our data, we implement comprehensive matching against a German municipal directory. This occurs in two phases:

1. **Exact Matching**: First we process our German directory to the same standards as the primary dataset, and attempt exact matches.

2. **Simplified Matching**: For unmatched cities, we apply a simplification function that removes common German administrative prefixes and suffixes:

```{r}
clean_german_city <- function(city_name) {
  city_name %>%
    str_remove("^BAD ") %>%                           # Remove "Bad" prefix
    str_remove("\\s+(AN|AM)\\s+(?:(DER|DEM)\\s+)?\\w+.*$") %>%  # Remove "an der/am" constructions
    str_remove("\\s+(A|V|I)[\\s\\.]*.*$") %>%         # Remove abbreviations  
    str_remove("-.*$") %>%                            # Remove hyphenated extensions
    str_trim()
}
```

This approach allows "BAD HOMBURG" to match to "HOMBURG" and "FRANKFURT AM MAIN", "FRANKFURT A.M", and "FRANKFURT A MAIN" to match to "FRANKFURT". 

## Ostgebeite

NNNTODO: For international locations, we prioritize modern political boundaries for consistency. 

## Non-missing city-level information

For cities that appear in both complete and incomplete records, we extract empirical patterns from the complete data to inform imputation. We identify all city-country combinations in records with non-missing birth country information, calculating the frequency with which each city corresponds to each country. Cities where a single country accounts for more than 50% of complete observations are assigned that dominant country. For example, since "DAMASKUS" appears in 43 complete records and 41 of those indicate Syria as the birth country, we assign Syria to any incomplete records listing "DAMASKUS" as the birth city. 

```{r}
# example table
```

This approach leverages the assumption that individuals sharing the same birth city are likely to share the same birth country, while accepting some ambiguity due to historical changes or data entry errors. 

## International City Matching

Unmatched cities are compared against the World Cities Database, which provides country assignments for major international urban centers. We prioritize cities with larger populations when multiple matches exist and exclude some problematic cities (such as "BISMARCK" which likely refers to the small German city rather than the large US city).

## Citizenship

When geographic matching fails, we fall back to citizenship information, which is less consistently associated with birth country, but still provides some information.

On the city level, we can attempt to identify country using an approach similar to one based on non-missing country of birth. Here, even if the country of birth is missing, we can check how many citizenship is assigned on records with a given city. Given the prevalent German citizenship and the existing reference list for German cities, we consider any non-German citizenships for the cities in question. Then, we calculate frequencies to search for dominant indications.

```{r}
# example table
```

As citizenship has valid reason to not be the same as birth country, we use a higher threshold and require 70% of citizenship to indicate a particular country to assign a city there.

## Individual Citizenship Assignment

For remaining cases, we assign birth country based on the individual's citizenship, prioritizing secondary citizenship when available. A simple tabulation of citizenship vs birth country alignment demonstrates that secondary citizenship aligns with birth country slightly more often. Note that there is also fairly substantial misalignment between citizenship and birth country, generally.

```{r}
# example table
```

## Implementation Summary

Though this hierarchical assignment of imputed birth country, we use reliable information if available, and less certain inference methods if necessary. Each individual record is processed through the complete hierarchy, with assignment occurring at the first successful match, while the source of each match is flagged to enable analysis of results.

# Results

This methodology successfully assigns birth countries to r NNN% of originally missing cases, with r NNN% based on geographic matching and r NNN% requiring citizenship-based inference.


In order of presumed reliability:
* German city matching accounts for approximately r NNN% of previously missing cases.

In order of overall impact:

## The gt package

Often that involves presenting data and results in a tabular format. The `gt` package provides a modern and flexible way to generate high-quality LaTeX or HTML tables from R objects.

### Showing data using gt

```{r, message=FALSE, warning=FALSE, results='asis'}
data(trees)

n <- 6
trees_sample <- trees %>%
  slice_sample(n = n) %>%
  mutate(Row = row_number()) %>%
  relocate(Row)

gt_latex <- trees_sample %>%
  gt() %>%
  tab_header(
    title = md(
      paste(n, "Observations from the `trees` Dataset")
      )
  ) %>%
  cols_label(
    Girth = "Diameter",
    Height = "Height",
    Volume = "Volume"
  ) %>%
  tab_options(
    latex.tbl.pos = "H", 
    latex.use_longtable = FALSE
  ) %>%
  as_latex()

# Replace \begin{table} with \begin{table}[H]
gt_latex <- gsub(
  "\\\\begin\\{table\\}", 
  "\\\\begin{table}[H]", 
  gt_latex
)

cat(gt_latex)
```

### Regression summary with `gt`

```{r, message=FALSE, warning=FALSE, results='asis'}
mod <- lm(Volume ~ Height, data = trees)
mod_summary <- tidy(mod)

gt_latex <- mod_summary %>%
  mutate(term = recode(
    term, "(Intercept)" = "Intercept")
    ) %>%
  gt() %>%
  tab_header(
    title = "OLS Regression: Volume ~ Height"
  ) %>%
  fmt_number(
    columns = where(is.numeric),
    decimals = 3
  ) %>%
  cols_label(
    term = "Term",
    estimate = "Estimate",
    std.error = "Std. Error",
    statistic = "t Statistic",
    p.value = "p-Value"
  ) %>%
  as_latex()

# Replace \begin{table} with \begin{table}[H]
gt_latex <- gsub(
  "\\\\begin\\{table\\}", 
  "\\\\begin{table}[H]", 
  gsub(
    "caption\\*", 
    "caption", 
    gsub(
      "\\\\begin\\{tabular\\*\\}", 
      "\\\\label{tab:olsrestab}\n\\\\begin{tabular*}", 
      gt_latex
    )
  )
)

cat(gt_latex)
```

Table \ref{tab:olsrestab} is a table with a label and thus can be referenced. Captioned tables will appear in the LOT.

## Visualization

We step through this using a dashboard.

```{r pop_dist, echo=FALSE, fig.cap="\\label{fig:pop_dist} Population Distribution", fig.height=4, fig.pos="t"}
# plot(pop_dist)
```

Looking at Figure \ref{fig:pop_dist} makes me happy.


```{r, fig.cap="Dataset and regression"}
plot(trees$Volume ~ trees$Height,
     xlab = "Height", 
     ylab = "Volume",
     main = "Linear Regression: Volume ~ Height")
abline(mod, col = "blue", lwd = 2)
```

# Conclusion

Missing data poses a persistent challenge in empirical research, particularly when key demographic variables are incomplete. This paper addresses the practical problem of imputing missing birth country information using auxiliary features and external reference datasets. 

We combine ; we use ; to assign the overall population. 

process can be continually refined. Expect matches to improve if we -- 
* handle historical countries and territories more intelligently. Some state codes are excessively separated (eg Yugoslavia vs Repulic of Yugoslavia), some are grouped unintuitively (namely Palestine and Taiwan). Currently we take state codes as they are given, including when calculating majority country/citizenship for particular cities.

This demonstrates how external reference data can be systematically integrated into the imputation process, incorporating knowledge about geographic and political relationships. 



\pagebreak

# Software References {-}
\addcontentsline{toc}{section}{Software References}

\newpage

# Appendix {-}
\addcontentsline{toc}{section}{Appendix}

## A.1 Description of relevant variables

## A.2 Fuzzy and manual matches
