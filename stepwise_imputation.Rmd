---
title: "Birth Country Imputation"
author: "Jamie Christy & Danaia Burtseva"
date: "2025-06-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Desktop/Schoolwork/2025_SoSe/ARE/Final Project/country-imputation")

library(tidyverse)
library(stringi) # for character standardization
library(stringdist) # for fuzzy matching
source('preprocess.R') # read/write external data
library(stringr)
library(readr)
library(rvest)
library(xml2)
```

# Topic 9: Birth Country Encryption

Key Concepts:
tidyverse, webscraping, functional programming, gt, shiny

Short Description:
The goal is to provide a suitable R interface to support the correction of missing values. Infer the country of birth from the place of birth and auxiliary features.

Tasks:
Develop a workflow to impute missing values in the birth_country variable using auxiliary features such as first_citizenship and second_citizenship, along with external reference data.
Your solution should include:
• A routine to obtain reference data on locations around the world (possibly also historical)
• A method of your choice for the imputation
• Support for files with unencrypted birth country data
• An interactive display of the results, including a success rate for exact matches.
• A visualization of the distribution of imputed birth countries.
• Optionally provide these features in a dashboard

# TODO

- gui/dashboard

- report
  - tables/debug
  - fuzzy
  - results
  - visualization
  - html dashboard
  - details in appendix
  
- clean code for production
  
- improve matching
  - https://ehemalige-ostgebiete.de/en systematic ostgebiete
  - transitive property
  - add NRW and RP databases for smaller cities
  - international list by distance
  - get historical list
  - use german city syntax for germany
  - patch misc (former yugoslav, taiwan/palestine)


# Prepare data

## Read raw 

```{r}
# preprocess_data(readin_raw = TRUE, writeout = TRUE) # first run
preprocess_data(readin_raw = FALSE, writeout = FALSE) # use cached
```


```{r}
# Birthdata
print(raw_df 
  %>% group_by(birth_country) %>% summarize(count=n())
  %>% arrange(desc(count))
)
```

```{r}
# DESTATIS - Staatenliste
states_df <- (states_df 
              %>% select(name,bev_state,iso_3)
              %>% filter(!is.na(bev_state))
              )

# Check bev codes with multiple labels
# print(states_df
#   %>% filter(bev_state %in% c("120", "132", "133", "138", "159", "162", "276", "995"))
#   %>% distinct()
# )

states_df %>% arrange(bev_state)
```


```{r}
fuzzy_key_df <- read_csv("fuzzy_picks.csv")
fuzzy_key_df
```

## Process main dataset

```{r}

data_df <- (raw_df
  %>% mutate(
    # Add person_id
    pid = row_number(),
    # Standardize characters
    birth_city = (birth_city
         %>% str_remove_all("[,´]")                # Remove inconsistent punctuation
         %>% stri_trans_general("Latin-ASCII")             # Remove accents
         %>% toupper()                                     # Ensure uppercase
         %>% str_replace_all("(JETZT|\\sJE[TZ]+T|\\sJ\\.|\\sJ\\s)+", "/")
         %>% str_replace_all("\\s+(KRS|KREIS|KRS\\.|K[\\.\\s])\\s+", "/")
         # %>% str_replace_all(" / ", "/")
         %>% str_remove("\\s+(0T|ORTSTEIL|STADT|BEZIRK|GEMEINDE).*$") # remove district markers
    ),
    birth_country = as.character(birth_country),
    # Swap unknowns to missing
    birth_city = replace(birth_city, 
                         birth_city %in% c("UNBEKANNT", "NICHT BEKANNT", "UNGEKLART"), 
                         NA_character_),
    # Extract parentheticals
    parenthetical = str_trim(str_extract(birth_city, "(?<=\\().*?(?=\\))")),  # Extract content
    birth_city = str_remove(birth_city, "\\s*\\(.*\\)") # Remove parentheticals
    )
  # Tag on names
  %>% left_join(states_df %>% select(bev_state, name, iso_3), join_by(birth_country==bev_state)  )
  %>% rename(bc_name=name, bc_iso3=iso_3)
)
# Save parentheticals
parentheticals_df <- data_df %>% select(pid, parenthetical) %>% distinct()

print(data_df %>% filter(str_detect(birth_city,'/')))

data_df <- (data_df
  # process slashes
  %>% mutate(original_city = birth_city)      # Preserve original
  %>% separate_rows(birth_city, sep = "/")          # Split into components
  %>% mutate(birth_city = str_trim(birth_city))     # Clean whitespace

  # fuzzy fix names
  %>% left_join(fuzzy_key_df %>% filter(!is.na(canon)) 
                %>% select(birth_city,canon), join_by(birth_city))
  %>% mutate(birth_city=case_when(!is.na(canon) ~ canon, .default=birth_city),
             fuzzy=case_when(!is.na(canon) ~ TRUE, .default=FALSE))
)



data_df

```

# City references

## German

```{r deu_cities}
# https://www.statistikportal.de/de/veroeffentlichungen/anschriftenverzeichnis
# Standardize formatting
deu_cities_df <- (
  deu_cities_df 
      %>% distinct()
      %>% mutate(
        deu_city = (deu_city
         %>% str_remove_all("[,´]")                # Remove inconsistent punctuation
         %>% stri_trans_general("Latin-ASCII")     # Remove accents
         %>% toupper()
         %>% str_remove_all(" STADT") ),
            imp_type="german_city"
              )
    %>% separate_rows(deu_city, sep = "/") # Register slashes separately  
    %>% filter(!is.na(deu_city) & deu_city!="ORT")
    %>% distinct()
    %>% arrange(deu_city)
              )

# Append nonparenthetical version
deu_cities_df <- bind_rows(deu_cities_df,
    deu_cities_df
    %>% filter(str_detect(deu_city, "\\(.*\\)"))              # Has parentheticals
    %>% mutate(
      deu_city = str_remove(deu_city, "\\s*\\(.*\\)"),       # Remove parentheticals
      deu_city = str_trim(deu_city)
    )
) %>% distinct() %>% arrange(deu_city)

# Append some manual names
deu_cities_df <- bind_rows(deu_cities_df,
data.frame(
  deu_city = c("WESTFALEN", "WESTF.", "WANNE-EICKEL", "WIEDENBRUCK", "HOLSTEIN", "KIRCHHELLEN"),
imp_type="german_city")
)

deu_cities_df

# print(deu_cities_df %>% filter(str_detect(deu_city, "WANN")))
```

```{r}
clean_german_city <- function(city_name) {
  (city_name
      %>% str_remove("\\s*-\\s*(GODESBERG|MITTE|SUD|NORD|OST|WEST|SAUERLAND).*$")
      %>% str_remove("\\s+(AN|AM)\\s+(?:(DER|DEM)\\s+)?\\w+.*$")
      %>% str_remove("\\s+(A|V|I)[\\s\\.]*.*$")
      %>% str_remove("\\s+(IM|IN)\\s+\\w+.*$")
      %>% str_remove(".*KRS[\\s\\.]*.*")
      %>% str_remove("^BAD ")
      %>% str_remove("-.*$")
      %>% str_trim())
}
```


```{r}
deu_base_cities_df = (
  deu_cities_df %>% mutate( deu_city=clean_german_city(deu_city) )
  %>% filter(!str_detect(deu_city, "VERWALTUNGSGEMEINSCHAFT"))
  %>% filter(deu_city!="OSTERODE") # Polish town not to be confused with Osterode am Harz
  %>% distinct
  %>% arrange(deu_city)
)

deu_base_cities_df
print(deu_base_cities_df %>% filter(str_detect(deu_city, "FALLINGBOSTEL")))

```

## World

```{r world_cities}
# https://simplemaps.com/data/world-cities
world_cities_df <- (world_cities_df 
                    %>% mutate(name=city %>% stri_trans_general("Latin-ASCII") %>% str_remove_all("[,´']")  %>% toupper())
                    # highest population version of name (switch to closest?)
                    %>% group_by(name)
                    %>% summarize(iso3=first(iso3),country=first(country),.groups="drop")
                    %>% filter(!(name %in% c("EPE","JORDAN", "TOLEDO", "BISMARCK")))
                    )
world_cities_df

# print(
#   cities_filled_df %>% filter(is.na(imp_birth_country) | imp_type=="world_list")
#   %>% inner_join(world_cities_df, join_by(birth_city==name)) 
#   %>% select(birth_city,country.y,iso3.y) %>% distinct()
# )
```

## Ostgebiete

```{r}
ostgebiete_df <-rbind(data.frame(
  # Poland
  birth_city = c("GROTTKAU", "SCHRODA", "SCHLESIEN", "OSTPR.", "OSTPREUSSEN", "NEIDENBURG","LABIAU","RASTENBURG","PYRITZ", "STREHLEN", "ANGERBURG", "LAUBAN", "SCHLOCHAU", "BUNZLAU"),
  ostgebiete = "152"
),data.frame(
  # Russia
  birth_city = c("GERDAUEN", "SAMLAND","GUMBINNEN","INSTERBURG","PR. EYLAU","WEHLAU","HEILIGENBEIL", "PREUSSISCH EYLAU", "ELCHNIEDERUNG", "FISCHHAUSEN", "ANGERAPP"),
  ostgebiete = "160"
),data.frame(
  # Lithuania
  birth_city = c("HEYDEKRUG"),
  ostgebiete = "142"
),data.frame(
  # Germany
  birth_city = c("WESERMUNDE", "RUPPIN", "EISLEBEN"),
  ostgebiete = "000" # kind of cheating
),data.frame(
  # Kosovo
  birth_city = c("PRISHTINA"),
  ostgebiete = "150" # definitely cheating
)
)

ostgebiete_df
```


# City-level internal information
## Non-missing birth_country

```{r}
city_country_df <- (
  data_df
  %>% filter(!is.na(birth_country) & !is.na(birth_city))
  %>% group_by(birth_city, birth_country, bc_name) %>% summarize(count=n(), .groups="drop")
  %>% arrange(desc(count))
)
city_country_df

# Summarize matches
multi_country_df <- (city_country_df
  %>% group_by(birth_city)
  %>% mutate(
    total_city_records = sum(count),
    pct_country = round(count / total_city_records * 100, 1)
  )
  %>% ungroup()
  %>% arrange(desc(total_city_records), birth_city, desc(count))
)
multi_country_df
print(multi_country_df %>% filter(pct_country<60 & pct_country>50))

best_countries_df <- (
  multi_country_df
  %>% filter(pct_country>50)
  %>% select(birth_city, birth_country, pct_country, total_city_records)
)
best_countries_df
print(multi_country_df %>% filter(birth_city=="DAMASKUS"))

```

## Citizenship

```{r}
city_citizens_df <- (
  data_df
  %>% select(birth_city, citizenship_1,citizenship_2)
  %>% filter(!is.na(birth_city))
  %>% anti_join(deu_cities_df, join_by(birth_city==deu_city))
  %>% pivot_longer(
    cols = c(citizenship_1, citizenship_2),
    names_to = "citizenship_type",
    values_to = "citizenship"
  )
  %>% mutate(citizenship=as.character(citizenship))
  %>% select(birth_city, citizenship)
  %>% filter(!is.na(citizenship) & citizenship != 0 & citizenship != 998)
  %>% group_by(birth_city, citizenship) %>% summarize(count=n(), .groups="drop")
  %>% arrange(desc(count))
)

# Summarize matches
multi_citizen_df <- (city_citizens_df
  %>% group_by(birth_city)
  %>% mutate(
    total_city_records = sum(count),
    pct_citizen = round(count / total_city_records * 100, 1)
  )
  %>% ungroup()
  %>% arrange(desc(total_city_records), birth_city, desc(count))
  %>% left_join(states_df, join_by(citizenship==bev_state))
)
print(multi_citizen_df %>% filter(pct_citizen>10))

best_citizens_df <- (
  multi_citizen_df
  %>% filter(pct_citizen>60)
  %>% select(birth_city, citizenship, pct_citizen, total_city_records)
)
best_citizens_df
print(multi_citizen_df %>% filter(birth_city=="BELGRAD"))

```


# Impute

## Helper functions

```{r}
# Collapse strings into alphabetized combination delimited by /
smart_collapse <- function(x, sep = "/") {
  clean_x <- x[!is.na(x) & x != ""]
  if(length(clean_x) == 0) return(NA_character_)
  paste(sort(unique(clean_x)), collapse = sep)
}
```

```{r}
# Convert back to individuals, marked with matched country(s) and fill with citizenship
collect_individuals <- function(cities_filled_df){
  data_filled_df <- (
    cities_filled_df
    
    # Smart collapse individuals
    %>% group_by(pid, citizenship_1, citizenship_2)
      %>% summarize(
      imp_type = smart_collapse(imp_type),
      imp_name = smart_collapse(imp_name),
      imp_iso3 = smart_collapse(imp_iso3),
      birth_country = smart_collapse(birth_country),
      birth_city = smart_collapse(birth_city),
      .groups = "drop"
    )
    
    # Use citizenship (prioritize second)
    %>% mutate(top_citizenship=as.character(coalesce(citizenship_2, citizenship_1)),
               top_citizenship=case_when(top_citizenship=="0"~"000", .default=top_citizenship),
               imp_birth_country=case_when(!is.na(imp_birth_country) ~ imp_birth_country, .default=top_citizenship),
               imp_type=case_when(!is.na(imp_type) ~ imp_type, .default="top_citizenship")
               )
    
    # labeled new imputed countries
    %>% left_join(states_df, join_by(top_citizenship==bev_state))
    %>% mutate(imp_name=coalesce(imp_name,name), imp_iso3=coalesce(imp_iso3,iso_3))
    %>% rename(citizenship=name)
    %>% select(pid,imp_type,birth_city,imp_name,imp_iso3,imp_birth_country,citizenship_1,citizenship_2,citizenship,birth_country)
  )
  
  return(data_filled_df)
}
```

```{r}
# Summarize working match

summarize_matches <- function(matched_df){
  working_city_match_df <- summarize_city_matches(matched_df)
  working_person_matches_df <- summarize_person_matches(working_city_match_df)
  plot_matches(working_person_matches_df)
}

# City matches
summarize_city_matches <- function(matched_df){
  working_city_match_df <- (
    matched_df
    # labeled imputed country
    %>% left_join(states_df, join_by(imp_birth_country==bev_state)  )
    %>% rename(imp_name=name, imp_iso3=iso_3)
  )
  
  # # Check data head
  # print(working_city_match_df 
  #       %>% select(pid,imp_type,birth_city,imp_iso3,citizenship_1,citizenship_2,original_city)
  #       %>% arrange(pid))
  
  # Count imp types
  print(working_city_match_df 
    %>% group_by(imp_type)
    %>% summarize(records=n(), .groups="drop")
    %>% arrange(desc(records))
  )
  
  return(working_city_match_df)
}

# Record matches
summarize_person_matches <- function(working_city_match_df){
  working_person_matches_df <- collect_individuals(working_city_match_df)
  print(working_person_matches_df
        %>% group_by(imp_type,imp_iso3)
        %>% summarize(records=n(), .groups="drop")
        %>% arrange(desc(records))
        )
  return(working_person_matches_df)
}

# Visual summary
plot_matches <- function(working_person_matches_df){
  country_summary_df <- (
    working_person_matches_df 
    %>% group_by(imp_iso3)
    %>% summarize(records=n(), .groups="drop")
    %>% arrange(desc(records))
    )
  print(country_summary_df)
}
```

```{r}
# Summarize unmatched records
summarize_unmatched <- function(unmatched_df){
  print(unmatched_df
        %>% group_by()
        %>% summarize(people=n_distinct(pid), cities=n(), .groups="drop")
        )
  print(unmatched_df
        %>% group_by(birth_city)
        %>% summarize(records = n(), .groups="drop")
        %>% arrange(desc(records))
        )
}
```


## Stepwise imputation

```{r}
# Baseline
matched_df <- (
  data_df
    %>% mutate(imp_birth_country=birth_country,
               imp_type=ifelse(!is.na(birth_country), "given", NA))
    %>% select(pid,imp_type,original_city,imp_birth_country,
               citizenship_1,citizenship_2,birth_city,birth_country)
)

unmatched_df <- matched_df %>% anti_join(matched_df %>% filter(!is.na(imp_type)), join_by(pid))

summarize_matches(matched_df)
summarize_unmatched(unmatched_df)
```

```{r}
# Abstract the repetitive imputation steps
apply_imputation <- function(impute_category){
  matched_df <<- rbind(matched_df %>% filter(!is.na(imp_birth_country)),
    unmatched_df
    %>% impute_category()
    %>% select(pid,imp_type,original_city,imp_birth_country,
                 citizenship_1,citizenship_2,birth_city,birth_country)
  )
  unmatched_df <<- matched_df %>% anti_join(matched_df %>% filter(!is.na(imp_type)), join_by(pid))
  
  summarize_matches(matched_df)
  summarize_unmatched(unmatched_df)
}
```

```{r}
# Option to undo a layer of matching
unmatch_category <- function(category){
  matched_df <<- (matched_df 
    %>% mutate(
      imp_birth_country=case_when(imp_type==category ~ NA, .default=imp_birth_country),
      imp_type=case_when(imp_type==category ~ NA, .default=imp_type)
    )
    )
  unmatched_df <<- matched_df %>% anti_join(matched_df %>% filter(!is.na(imp_type)), join_by(pid))
}

# unmatch_category("city_o50")
# summarize_matches(matched_df)

```


```{r}
# German reference list
impute_german <- function(data_df){(
    data_df
    # Join reference list
    %>% left_join(deu_cities_df
                %>% rename(birth_city=deu_city, imp_deu=imp_type)
                , by="birth_city")
    # Mark new imputations
    %>% mutate(imp_birth_country=case_when(
                   !is.na(imp_birth_country) ~ imp_birth_country,
                   !is.na(imp_deu) ~ "000", # german match
                   ),
               imp_type=case_when(
                   !is.na(imp_type) ~ imp_type,
                   !is.na(imp_deu) ~ imp_deu)
    )
)}

apply_imputation(impute_german)
```

```{r}
# World Cities List
impute_world <- function(data_df){(
    data_df
    # World cities matches
    %>% left_join(world_cities_df, join_by(birth_city==name))
    %>% left_join(states_df %>% select(world_id=bev_state,iso_3) %>% distinct() 
                  %>% filter(!(world_id %in% c(133, 276))) # Exclude older codes
                  , join_by(iso3==iso_3))
    # Mark new imputations
    %>% mutate(imp_birth_country=case_when(
                   !is.na(imp_birth_country) ~ imp_birth_country,
                   !is.na(world_id) ~ world_id
                   ),
               imp_type=case_when(
                   !is.na(imp_type) ~ imp_type,
                   !is.na(world_id) ~ "world_list")
    )
)}

apply_imputation(impute_world)
```

```{r}
# Ostgebeit matches
impute_ost <- function(data_df){(
    data_df
    # Join reference list
    %>% left_join(ostgebiete_df, by="birth_city")
    # Mark new imputations
    %>% mutate(imp_birth_country=case_when(
                   !is.na(imp_birth_country) ~ imp_birth_country,
                   !is.na(ostgebiete) ~ ostgebiete
                   ),
               imp_type=case_when(
                   !is.na(imp_type) ~ imp_type,
                   !is.na(ostgebiete) ~ "ostgebiete")
    )
)}

apply_imputation(impute_ost)

```

```{r}
# Parseable countries
impute_literal <- function(data_df){(
    data_df
      # Parenthetical matches
    %>% left_join(parentheticals_df, join_by(pid))
      %>% left_join(
        states_df %>% select(bev_state, name)
        %>% mutate(name = name %>% stri_trans_general("Latin-ASCII") %>% toupper()),
        by = c("parenthetical" = "name")
      )
      # Cities that are a country name
      %>% left_join(
        states_df %>% select(lit_state=bev_state, name)
        %>% mutate(country_literal=TRUE)
        %>% mutate(name = name %>% stri_trans_general("Latin-ASCII") %>% toupper()),
        by = c("birth_city" = "name")
      )
    # Mark new imputations
    %>% mutate(imp_birth_country=case_when(
                   !is.na(imp_birth_country) ~ imp_birth_country,
                   !is.na(bev_state) ~ bev_state, # parenthetical
                   country_literal ~ lit_state, # city is country
                   ),
               imp_type=case_when(
                   !is.na(imp_type) ~ imp_type,
                   !is.na(bev_state) ~ "country_literal", # parenthetical
                   country_literal ~ "country_literal" # city is country
               )
    )
)}

apply_imputation(impute_literal)
```

```{r}
# Internally assigned city-countries
impute_nm_country <- function(data_df){(
    data_df
    # Join reference list
    %>% left_join(best_countries_df
                    %>% rename(city_birth_country=birth_country)
                    , by="birth_city")
    # Mark new imputations
    %>% mutate(imp_birth_country=case_when(
                   !is.na(imp_birth_country) ~ imp_birth_country,
                   pct_country>=50 ~ city_birth_country
                   ),
               imp_type=case_when(
                   !is.na(imp_type) ~ imp_type,
                   pct_country==100 ~ "unique_city",
                   pct_country>=50 ~ "city_o50"
                   
                   )
    )
)}

apply_imputation(impute_nm_country)
```

```{r}
# Expanded German processing
impute_german_base <- function(data_df){(
    data_df
    # Strip German details
    %>% mutate(
      base_city=clean_german_city(birth_city)
      )
    # Base German reference list
    %>% left_join(deu_base_cities_df
                %>% rename(base_city=deu_city, imp_deu_expanded=imp_type)
                , by="base_city")
    # Mark new imputations
    %>% mutate(imp_birth_country=case_when(
                   !is.na(imp_birth_country) ~ imp_birth_country,
                   !is.na(imp_deu_expanded) ~ "000" # german base
                   ),
               imp_type=case_when(
                   !is.na(imp_type) ~ imp_type,
                   !is.na(imp_deu_expanded) ~ "german_base")
    )
)}

apply_imputation(impute_german_base)


```


```{r}
# Citizenship-based cities
impute_citizens <- function(data_df){(
    data_df
    # Join reference list
    %>% left_join(best_citizens_df
                  %>% filter(total_city_records>1) # at 1, equivalent to top citizenship
                  , by="birth_city")
    # Mark new imputations
    %>% mutate(imp_birth_country=case_when(
                   !is.na(imp_birth_country) ~ imp_birth_country,
                   pct_citizen>=70 ~ citizenship
                   ),
               imp_type=case_when(
                   !is.na(imp_type) ~ imp_type,
                   pct_citizen==100 ~ "unique_citizen",
                  pct_citizen>=70 ~ "citizen_o70")
    )
)}

apply_imputation(impute_citizens)
  
```




## Full imputation

Note: running everything at once is less flexible, quicker, and flags individuals assigned to multiple categories due to the "/" parsing. 

```{r}
# Run each imputation method and mark sources
match_cities <- function(data_df){
  cities_filled_df <- (
    data_df
    %>% mutate(imp_birth_country=birth_country,
               imp_type=ifelse(!is.na(birth_country), "given", NA))
    
    # German list matches
    %>% left_join(deu_cities_df
                %>% rename(birth_city=deu_city, imp_deu=imp_type)
                , by="birth_city")
    
    # Ostgebeit matches
    %>% left_join(ostgebiete_df, by="birth_city")
    
    # Parenthetical matches
    %>% left_join(
      states_df %>% select(bev_state, name)
      %>% mutate(name = name %>% stri_trans_general("Latin-ASCII") %>% toupper()),
      by = c("parenthetical" = "name")
    )
    # Cities with a country name
    %>% left_join(
      states_df %>% select(lit_state=bev_state, name)
      %>% mutate(country_literal=TRUE)
      %>% mutate(name = name %>% stri_trans_general("Latin-ASCII") %>% toupper()),
      by = c("birth_city" = "name")
    )
  
    # World cities matches
    %>% left_join(world_cities_df, join_by(birth_city==name))
    %>% left_join(states_df %>% select(world_id=bev_state,iso_3) %>% distinct() 
                  %>% filter(!(world_id %in% c(133, 276))) # Exclude older codes
                  , join_by(iso3==iso_3))
    
    # Internally assigned city-countries
    %>% left_join(best_countries_df
                  %>% rename(city_birth_country=birth_country)
                  , by="birth_city")
  
    # Expanded German processing
    %>% mutate(
      base_city=clean_german_city(birth_city)
      )
    %>% left_join(deu_base_cities_df
                %>% rename(base_city=deu_city, imp_deu_expanded=imp_type)
                , by="base_city")
  
    # Citizenship-based cities
    %>% left_join(best_citizens_df
                  %>% filter(total_city_records>1) # at 1, equivalent to top citizenship
                  , by="birth_city")
  
    %>% mutate(imp_birth_country=case_when(
                 !is.na(imp_birth_country) ~ imp_birth_country, # given
                 !is.na(imp_deu) ~ "000", # german match
                 !is.na(bev_state) ~ bev_state, # parenthetical
                 country_literal ~ lit_state, # city is country
                 !is.na(ostgebiete) ~ ostgebiete,
                 !is.na(world_id) ~ world_id,
                 !is.na(imp_deu_expanded) ~ "000", # german base
                 pct_country>=50 ~ city_birth_country,
                 pct_citizen>=70 ~ citizenship
                 ),
  
               imp_type=case_when(
                 !is.na(imp_type) ~ imp_type,
                 fuzzy & !is.na(imp_birth_country) ~ "fuzzy",
                 !is.na(imp_deu) ~ imp_deu,
                 !is.na(imp_deu_expanded) ~ "german_base",
                 !is.na(bev_state) ~ "country_literal", # parenthetical
                 country_literal ~ "country_literal", # city is country
                 !is.na(ostgebiete) ~ "ostgebiete",
                 pct_country==100 ~ "unique_city",
                 pct_country>=50 ~ "city_o50",
                 !is.na(world_id) ~ "world_list",
                 pct_citizen==100 ~ "unique_citizen",
                 pct_citizen>=70 ~ "citizen_o70"
                 )
               )
    
    # labeled imputed country
    %>% left_join(states_df, join_by(imp_birth_country==bev_state)  )
    %>% rename(imp_name=name, imp_iso3=iso_3)
  )
  return(cities_filled_df)
}
```

```{r}
cities_filled_df <- match_cities(data_df)
data_filled_df <- collect_individuals(cities_filled_df)
```


```{r}

print(data_filled_df 
      %>% group_by(imp_type) 
      %>% summarize(n = n(), .groups="drop")
      %>% mutate(pct=n/48031 * 100)
      %>% arrange(desc(n))
      )

print(data_filled_df 
      %>% filter(imp_type!="given")
      %>% group_by(imp_type) 
      %>% summarize(n = n(), .groups="drop")
      %>% mutate(pct=n/(48031-29217) * 100)
      %>% arrange(desc(n))
      )
```

# QA and investigations

```{r}
# Check citizenship-birth relationships
print(data_filled_df
      %>% filter(!is.na(citizenship_2) & !is.na(imp_birth_country))
      %>% mutate(
        citizenship_1 = case_when(citizenship_1=="0"~"000",.default=citizenship_1),
        c1_match = citizenship_1==imp_birth_country,
        c2_match = citizenship_2==imp_birth_country,
        deu = citizenship_1 == "000"
      )
      %>% group_by(c1_match,c2_match,deu) %>% summarize(n=n(), .groups="drop") %>% arrange(desc(n))
)
```

```{r}
print(data_filled_df 
      %>% filter(is.na(birth_country)) 
      %>% group_by(imp_type, imp_birth_country, imp_name, imp_iso3) %>% summarize(n = n(), .groups="drop") 
      %>% arrange(desc(n))
      )

print(data_filled_df 
      %>% filter(!is.na(birth_country)) 
      %>% group_by(imp_birth_country, imp_name, imp_iso3) %>% summarize(n = n(), .groups="drop") 
      %>% arrange(desc(n))
      )

print(data_filled_df 
      %>% filter(is.na(birth_country)) 
      %>% filter(imp_type!="top_citizenship")
      %>% group_by(imp_birth_country, imp_name, imp_iso3) %>% summarize(n = n(), .groups="drop") 
      %>% arrange(desc(n))
      )

print(data_filled_df 
      %>% group_by(imp_birth_country, imp_name, imp_iso3) %>% summarize(n = n(), .groups="drop") 
      %>% mutate(pct=n/48031 * 100)
      %>% arrange(desc(n))
      )
```


```{r}
# Check world list cities
print(cities_filled_df 
      # %>% filter(is.na(imp_birth_country)) 
      # %>% anti_join(data_filled_df %>% filter(!is.na(imp_birth_country)),by=c("pid"))
      %>% filter(imp_type=="world_list")
      # %>% group_by(birth_city) 
      # %>% group_by(birth_city,imp_name) %>% summarize(n = n(), .groups="drop")
      # %>% arrange(desc(n))
      )

# Check unique cities
print(cities_filled_df 
      # %>% filter(is.na(imp_birth_country)) 
      # %>% anti_join(data_filled_df %>% filter(!is.na(imp_birth_country)),by=c("pid"))
      %>% filter(imp_type=="city_o50")
      # %>% group_by(birth_city) 
      %>% group_by(birth_city,imp_name) %>% summarize(n = n(), .groups="drop")
      %>% arrange(desc(n))
      )
```

```{r}
# Fuzzy match unindentified cities
fuzzy_candidates <- (
  cities_filled_df 
  %>% filter(imp_type=="top_citizenship" | birth_city!=original_city)
  %>% select(birth_city) %>% distinct()
  %>% rowwise()
  %>% mutate(
    edit1_deu = {
      candidates <- deu_base_cities_df$deu_city[
        abs(nchar(deu_base_cities_df$deu_city) - nchar(birth_city)) <= 1
        & nchar(deu_base_cities_df$deu_city) > 5
      ]
      distances <- stringdist(birth_city, candidates, method = "dl")
      matches <- candidates[distances == 1]
      if(length(matches) >= 1) matches[1] else NA_character_
      # matches
    },
    edit1_int = {
      candidates <- best_countries_df$birth_city[
        abs(nchar(best_countries_df$birth_city) - nchar(birth_city)) <= 1
        & nchar(birth_city) > 5
      ]
      distances <- stringdist(birth_city, candidates, method = "dl")
      matches <- candidates[distances == 1]
      if(length(matches) >= 1) matches[1] else NA_character_
      # matches
    },
    edit1_eng = {
      candidates <- world_cities_df$name[
        abs(nchar(world_cities_df$name) - nchar(birth_city)) <= 1
        & nchar(birth_city) > 5
      ]
      distances <- stringdist(birth_city, candidates, method = "dl")
      matches <- candidates[distances == 1]
      if(length(matches) >= 1) matches[1] else NA_character_
      # matches
    }
  )
  %>% ungroup()
  %>% filter(!is.na(edit1_deu) | !is.na(edit1_int) | !is.na(edit1_eng) )
)
fuzzy_candidates

# write_csv(fuzzy_candidates, "fuzzy_candidates.csv")
```


```{r}
# Unidentified
print(cities_filled_df 
      # %>% filter(is.na(imp_birth_country)) 
      %>% anti_join(data_filled_df %>% filter(imp_type!="top_citizenship"),by=c("pid"))
      # %>% group_by(birth_city) %>% summarize(n = n(), .groups="drop")
      %>% group_by(birth_city) %>% summarize(n = n(), .groups="drop")
      %>% arrange(desc(n))
      )

print(data_filled_df 
      %>% filter(imp_type=="top_citizenship")
      %>% select(pid, citizenship_1, citizenship_2,birth_city)
      )

print(data_filled_df 
      %>% filter(imp_type=="top_citizenship")
      %>% filter(str_detect(birth_city,"/"))
      %>% select(pid, citizenship_1, citizenship_2,birth_city)
      )
```


```{r}
# Check raw names
print(
  raw_df
  %>% mutate(pid = row_number())
  %>% inner_join(data_filled_df 
                 %>% filter(imp_type=="top_citizenship")
                 %>% select(birth_city, pid), join_by(pid))
  %>% filter(str_detect(birth_city.y,"/"))
)

# Cities without countries assigned
print(cities_filled_df 
      %>% inner_join(cities_filled_df 
                     %>% filter(birth_city %in% c("LABIAU","SCHLESIEN","GERDAUEN")) %>% select(pid) %>% distinct(), 
                     by = join_by(pid))
      %>% select(pid,imp_type,imp_name,birth_country,birth_city,citizenship_1,citizenship_2)
      %>% arrange(pid, birth_city)
      )

# Cities without countries assigned
print(data_filled_df 
      %>% inner_join(cities_filled_df 
                     %>% filter(birth_city %in% c("LABIAU","SCHLESIEN","GERDAUEN")) %>% select(pid) %>% distinct(), 
                     by = join_by(pid))
      %>% select(pid,imp_type,imp_name,birth_country,birth_city,citizenship_1,citizenship_2)
      %>% arrange(birth_city,birth_country)
      )

print(data_filled_df %>% filter(str_detect(birth_city, "RASTEN")))

```


# Resolve multi-classed

```{r}

# Multi-matches
print(data_filled_df 
      %>% filter(str_detect(imp_birth_country, "/"))
      # %>% filter(pid==32942)
      )

print(cities_filled_df 
      %>% inner_join(data_filled_df%>% filter(str_detect(imp_birth_country, "/"))%>%select(pid), join_by(pid))
      )

# When citizenship matches one, use that one
# prioritize in same hierarchy as imputation
```



#  Handle multiple birth countries/cities
```{r}
multiple_cities <- data_filled_df %>%
  filter(str_detect(imp_birth_country, "/")) %>%
  separate(
    birth_city,
    into = c("city_1", "city_2", "city_3", "city_4"),
    sep = "/", fill = "right", extra = "merge"
  ) %>%
  select(pid, city_1, city_2, city_3, city_4, imp_birth_country, imp_type)
```



# Join with world cities to get countries
```{r}

multiple_cities%>%
	group_by(imp_birth_country)%>%
	summarise(n = n(), .groups = "drop") %>%
  filter(n > 1) %>%
  arrange(desc(n))


```


# 3. Assign known historical cities ostgebiet (Poland and Russia)
```{r}
# Make lookup: German_name_clean → ostgebiete
ost_lookup <- setNames(ostgebiete_df$ostgebiete, ostgebiete_df$birth_city)

multiple_cities <- multiple_cities %>%
  mutate(
    city_1_country = ost_lookup[city_1],
    city_2_country = ost_lookup[city_2],
    city_3_country = ost_lookup[city_3],
    city_4_country = ost_lookup[city_4]
  )
```


```{r}
# Function to resolve countries
resolve_exonym_country <- function(...) {
  vals <- na.omit(c(...))       # collect non-NA values
  if (length(vals) == 0) {
    return(NA_character_)
  } else if (length(unique(vals)) == 1) {
    return(unique(vals))        # single unique value
  } else {
    return("ambiguous")         # conflicting
  }
}

# Apply function rowwise
multiple_cities <- multiple_cities %>%
  rowwise() %>%
  mutate(
    exonym_country = resolve_exonym_country(
      city_1_country, city_2_country, city_3_country, city_4_country
    )
  ) %>%
  ungroup()


multiple_cities%>%
  filter(is.na(exonym_country))%>%
	group_by(imp_birth_country)%>%
	summarise(n = n(), .groups = "drop") %>%
  filter(n > 1) %>%
  arrange(desc(n))
```





# 5. Scrape German exonyms for Poland from Wikipedia

```{r}
multiple_cities_poland<-multiple_cities%>%
  filter(is.na(exonym_country))%>%
  filter(imp_birth_country=="000/152")

multiple_cities_poland
```


```{r}


#  Wikipedia
url_pol <- "https://en.wikipedia.org/wiki/List_of_German_names_for_places_in_Poland"


# html
page <- read_html(url_pol)

# all tables
tables <- page %>% html_table(fill = TRUE)

# table 2
german_names_in_Poland <- tables[[2]] %>%
  as.data.frame() %>%
  rename(
    Polish_name = 1,
    German_name = 5
  ) %>%
  # filter(!is.na(German_name) & German_name != "") %>%
  mutate(Poland = "152")

german_names_in_Poland<- german_names_in_Poland %>%
  mutate(
    Polish_name_clean = Polish_name %>%
      str_remove(",.*$") %>%  
      str_remove_all("[´]") %>%  
      str_remove_all("\\[[a-zA-Z]\\]") %>%
      stri_trans_general("Latin-ASCII") %>%          #  (ł → l, ś → s и т.п.)
      toupper() %>%                                  #
      str_replace_all("(JETZT|\\sJE[TZ]+T|\\sJ\\.|\\sJ\\s)+", "/") %>% # заменить формы "JETZT" → "/"
      str_replace_all("\\s+(KRS|KREIS|KRS\\.|K[\\.\\s])\\s+", "/") %>% # KRS/KREIS → "/"
      # str_replace_all(" / ", "/")                  # при желании убрать пробелы вокруг "/"
      str_remove("\\s+(0T|ORTSTEIL|STADT|BEZIRK|GEMEINDE).*$") # убрать хвосты типа "Ortsteil ..."
  )


german_names_in_Poland<- german_names_in_Poland %>%
  mutate(
    German_name_clean = German_name %>%
      str_remove(",.*$") %>%  
      str_remove_all("[´]") %>% 
      str_remove_all("\\[[a-zA-Z]\\]") %>%
      stri_trans_general("Latin-ASCII") %>%          #  (ł → l, ś → s и т.п.)
      toupper() %>%                                  #
      str_replace_all("(JETZT|\\sJE[TZ]+T|\\sJ\\.|\\sJ\\s)+", "/") %>% #  "JETZT" → "/"
      str_replace_all("\\s+(KRS|KREIS|KRS\\.|K[\\.\\s])\\s+", "/") %>% # KRS/KREIS → "/"
      # str_replace_all(" / ", "/")                  #  "/"
      str_remove("\\s+(0T|ORTSTEIL|STADT|BEZIRK|GEMEINDE).*$") #  "Ortsteil ..."
  )


german_names_in_Poland_no_unique <-german_names_in_Poland%>%
  group_by(German_name_clean) %>%
  summarise(n = n(), .groups = "drop") %>%
  filter(n > 1) %>%
  arrange(desc(n))




HOHENSTEIN <- inner_join(
  multiple_cities_poland,
  german_names_in_Poland_no_unique,
  by = c("city_1" = "German_name_clean")
)

# HOHENSTEIN
# HOHENSTEIN
# OSTERODE
```



```{r}
remove_list <- german_names_in_Poland_no_unique$German_name_clean[
  !(german_names_in_Poland_no_unique$German_name_clean %in% c("HOHENSTEIN"))
]

```


```{r}

german_names_in_Poland <- german_names_in_Poland %>%
  filter(!German_name_clean %in% remove_list)

german_names_in_Poland <- german_names_in_Poland %>%
  filter(!(German_name_clean == "HOHENSTEIN" & Polish_name_clean == "PSZCZOLKI"))

write_csv(german_names_in_Poland, "german_names_in_Poland.csv")

```


```{r}
# Make lookup: German_name_clean → ostgebiete



pol_lookup <- setNames(german_names_in_Poland$Poland, german_names_in_Poland$German_name_clean)

multiple_cities_poland <- multiple_cities %>%
  mutate(
    city_1_country = pol_lookup[city_1],
    city_2_country = pol_lookup[city_2],
    city_3_country = pol_lookup[city_3],
    city_4_country = pol_lookup[city_4]
  )

multiple_cities_poland 
# Apply function rowwise
multiple_cities_poland <- multiple_cities_poland %>%
  rowwise() %>%
  mutate(
    exonym_country = resolve_exonym_country(
      city_1_country, city_2_country, city_3_country, city_4_country
    )
  ) %>%
  ungroup()

multiple_cities_poland_small <- multiple_cities_poland %>%
  select(pid, exonym_country)

multiple_cities_poland%>%
  filter(is.na(exonym_country))

```



```{r}

# Create URLs
urls <- c("https://de.wikipedia.org/wiki/Liste_der_Städte_in_der_Woiwodschaft_Ermland-Masuren",

"https://de.wikipedia.org/wiki/Liste_der_Städte_in_der_Woiwodschaft_Lebus",
"https://de.wikipedia.org/wiki/Liste_der_Städte_in_der_Woiwodschaft_Niederschlesien",
"https://de.wikipedia.org/wiki/Woiwodschaft_Westpommern",
"https://de.wikipedia.org/wiki/Woiwodschaft_Opole",
"https://de.wikipedia.org/wiki/Woiwodschaft_Schlesien")

# Print the URLs
print(urls)



# Initialize list to store tables
all_tables <- list()

# Loop over URLs
for (u in urls) {
  page <- read_html(u)
  tables <- page %>% html_table(fill = TRUE)
  all_tables[[u]] <- tables
}


ostpruss<-list(

all_tables[[1]][[2]]%>%
  select(Stadt, `Deutscher Name`),

all_tables[[2]][[2]]%>%
  select(Stadt, `Deutscher Name`),

all_tables[[3]][[2]]%>%
  select(Stadt, `Deutscher Name`),

all_tables[[4]][[5]]%>%
  select(Stadt, `Deutscher Name`),

all_tables[[5]][[5]]%>%
  select(Stadt, `Deutscher Name`),

all_tables[[6]][[5]]%>%
  select(Stadt, `Deutscher Name`)
)

ostpruss_df <- bind_rows(ostpruss)

# Apply the cleaning function to the "Deutscher Name" column

```



````{r}
ostpruss_df <- ostpruss_df %>%
  mutate(`German_name_cleaned` = `Deutscher Name` %>%
           str_remove(",.*$") %>%                    # remove comma and everything after
           str_remove_all("[´]") %>%                 # remove accent marks
           str_remove_all("\\s+in Ostpreußen") %>% 
           str_remove_all("\\[[a-zA-Z]\\]") %>%     # remove [g], [h] etc.
           stri_trans_general("Latin-ASCII") %>%    # convert ł → l, ś → s etc.
           toupper() %>%                             # uppercase all letters
           str_replace_all("(JETZT|\\sJE[TZ]+T|\\sJ\\.|\\sJ\\s)+", "/") %>%  # replace "JETZT" variations with "/"
           str_replace_all("\\s+(KRS|KREIS|KRS\\.|K[\\.\\s])\\s+", "/") %>% # replace KRS/KREIS with "/"
           str_remove("\\s+(0T|ORTSTEIL|STADT|BEZIRK|GEMEINDE).*$")         # remove "Ortsteil ..." and similar
         )


ostpruss_df <- ostpruss_df %>%
  mutate(`Polish_name_cleaned` = `Stadt` %>%
           str_remove(",.*$") %>%                    # remove comma and everything after
           str_remove_all("[*´]") %>%                 # remove accent marks
           str_remove_all("\\s+IN OSTPREUSSEN") %>%  # remove "IN OSTPREUSSEN"
           str_remove_all("\\[[a-zA-Z]\\]") %>%     # remove [g], [h] etc.
           stri_trans_general("Latin-ASCII") %>%    # convert ł → l, ś → s etc.
           toupper() %>%                             # uppercase all letters
           str_replace_all("(JETZT|\\sJE[TZ]+T|\\sJ\\.|\\sJ\\s)+", "/") %>%  # replace "JETZT" variations with "/"
           str_replace_all("\\s+(KRS|KREIS|KRS\\.|K[\\.\\s])\\s+", "/") %>% # replace KRS/KREIS with "/"
           str_remove("\\s+(0T|ORTSTEIL|STADT|BEZIRK|GEMEINDE).*$")         # remove "Ortsteil ..." and similar
         )

ostpruss_df <- ostpruss_df %>%
  filter(`German_name_cleaned` != "FREYSTADT") %>%
  mutate(`Polish country` = "152")



````


# 7. Build exonym reference table
```{r}


pol_lookup_0 <- setNames(
  ostpruss_df$`Polish country`,
  ostpruss_df$German_name_cleaned
)

multiple_cities_poland_0 <- multiple_cities_poland %>%
  filter(is.na(exonym_country)) %>%
  mutate(
    city_1_country_0 = pol_lookup_0[city_1],
    city_2_country_0 = pol_lookup_0[city_2],
    city_3_country_0 = pol_lookup_0[city_3],
    city_4_country_0 = pol_lookup_0[city_4]
  ) %>%
  rowwise() %>%
  mutate(
    exonym_country_0 = resolve_exonym_country(
      city_1_country_0, city_2_country_0, city_3_country_0, city_4_country_0
    )
  ) %>%
  ungroup()

multiple_cities_poland_0_small <- multiple_cities_poland_0 %>%
  select(pid, exonym_country_0)
# 
# multiple_cities_poland_0_small
# multiple_cities_poland_0%>%
#   filter(is.na(exonym_country))
# 
# multiple_cities_poland%>%
#   filter(is.na(exonym_country))

```





# 8. Impute exonym country back into main dataset
```{r}

multiple_cities<-left_join(multiple_cities,multiple_cities_poland_small,
  multiple_cities_poland_0_small,
  by = "pid"
)

multiple_cities
```


```{r}


# Apply function rowwise
multiple_cities <- multiple_cities %>%
  rowwise() %>%
  mutate(
    modern_birth_country = resolve_exonym_country(
      exonym_country.x, exonym_country.y, exonym_country
    )
  ) %>%
  ungroup()

multiple_cities%>%
  filter(is.na(modern_birth_country))



```

